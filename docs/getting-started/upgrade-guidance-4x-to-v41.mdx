---
sidebar_position: 6
title: 'Upgrade Guidance: v4 to v4.1'
description: 'Upgrade guidance for those coming from v4.0.'
slug: /getting-started/upgrade-guidance-4x-to-v41
hide_title: true
tags:
  - Usage
  - Migration
  - Getting Started
---

# Upgrade Guidance: v4 to v4.1

## Breaking Changes in v4.1

:::warning
- `DeployMode` now defaults to a new mode `Auto`, which defaults to interactive but reverts to silent if the device is in OOBE/ESP phases, there is no user logged on, or there are no processes to close.
- `OOBEDetection` and `SessionDetection` are no longer set in Config.psd1. They can be set per-deployment by adding the `NoOOBEDetection` and `NoSessionDetection` options to the session properties if required.
- `AppProcessesToClose` is a new session property that allows you to define processes to close during Install/Uninstall/Repair in one place instead of specifying the processes directly on the `-CloseProcesses` parameter of `Show-ADTInstallationWelcome`.
- `RequireAdmin` is no longer set in Config.psd1. It must be set per-deployment in the session properties.
- Several config options have been removed or had their default values changed. See below for details.
- Deprecated functions and parameters are scheduled for removal in 4.2.0. Update your scripts accordingly.
:::

## Updating an Existing v4.0 Deployment to v4.1

For patch releases (e.g. v4.0.5 to v4.0.6), all that is normally required is to replace the PSAppDeployToolkit folder within the package.

However there are a number of changes to various toolkit files in 4.1 to be aware of.

## Changes in Invoke-AppDeployToolkit.ps1

:::note
`AppProcessesToClose` and `RequireAdmin` are now set in the `$adtSession` object. This is a breaking change from previous versions. See the examples below for the new pattern.
:::

There are 2 new additions to the $adtSession hashtable:

```powershell
$adtSession = @{
    # App variables.

    AppProcessesToClose = @('excel', @{ Name = 'winword'; Description = 'Microsoft Word' })

    RequireAdmin = $true
}
```

- `AppProcessesToClose` allows you to specify the processes to be closed in one place, saving you from copying the same list to the Uninstall and Repair sections of your script. If `DeployMode` is set to `Auto` (the default), the toolkit will automatically switch to `Silent` if none of the defined processes are running when the session is opened. This can be disabled by setting the `-NoProcessDetection` option when opening the session.
- `RequireAdmin` has been moved from the config file to the template, since it is a per-package setting. If set to `$true`, the script will fail at the point of opening the session if the user does not have administrative privileges.

The `Show-ADTInstallationWelcome` example has been updated to use [splatting](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_splatting):

```powershell
$saiwParams = @{
    AllowDefer = $true
    DeferTimes = 3
    CheckDiskSpace = $true
    PersistPrompt = $true
}
if ($adtSession.AppProcessesToClose.Count -gt 0)
{
    $saiwParams.Add('CloseProcesses', $adtSession.AppProcessesToClose)
}
Show-ADTInstallationWelcome @saiwParams
```

This allows you to more easily read the options being set, and will only add CloseProcesses to the parameter list if it's not empty. You are still welcome to use the method from the v4.0 template if you prefer - the template is provided for your customisation.

The last important change is this line that calls `Remove-ADTHashtableNullOrEmptyValues` to strip out any null or empty values from the `$adtSession` hashtable before it is passed to the `Open-ADTSession` function:

```powershell
    $adtSession = Remove-ADTHashtableNullOrEmptyValues -Hashtable $adtSession ⬅️
    $adtSession = Open-ADTSession @adtSession @iadtParams -PassThru
```

## OOBE and Session Detection Changes

:::warning
OOBE and session detection logic has changed in 4.1. OOBE detection now includes the User ESP phase, and you can now bypass OOBE or session detection per deployment using the new `NoOobeDetection` and `NoSessionDetection` session parameters. Review your scripts and config if you rely on the old behavior.
:::

## Changes in Config.psd1

Changed defaults:

| Option                   | Default                   | Description                                                        |
| ------------------------ | ------------------------- | ------------------------------------------------------------------ |
| MSI.InstallParams        | /qn REBOOT=ReallySuppress | Default MSI parameters for installation.                           |
| MSI.LogPath              |                           | Now uses the same path as Toolkit.LogPath when empty.              |
| MSI.LogPathNoAdminRights |                           | Now uses the same path as Toolkit.LogPathNoAdminRights when empty. |
| UI.DeferExitCode         | 1602                      | Default exit code for deferred installations.                      |

Removed options:

- Toolkit.OobeDetection
- Toolkit.SessionDetection
- Toolkit.RequireAdmin

## Changes in Strings.psd1

There have been extensive changes to the Strings.psd1 files for each language, too many to list here. Please submit an issue or pull request on GitHub if you are able to improve any of the translations!

## Additional Migration Notes

:::note

- Use the migration tools (`Test-ADTCompatibility`, `Convert-ADTDeployment`) to help update your scripts.
- Review all function and parameter deprecations in the [release notes](../getting-started/release-notes.mdx).
:::
